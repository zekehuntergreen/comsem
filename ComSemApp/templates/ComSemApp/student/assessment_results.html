{% extends 'ComSemApp/sidebar.html' %}

{% load static %}

{% block content %}
<style>
    .row-indent {
        padding-left: 40px !important;
    }
    .my-table th, .my-table td {
        text-align: left;
        width: 33%%
    }
</style>

<script type="text/javascript">
    function showHideRow(row){
        /*
            toggles (hides/shows) the "show more" row that
            is inputted as a parameter
        */
        $("#" + row).toggle();
        $("#showMoreButton" + row).text((i, text) => {
            return text === "Show More" ? "Show Less" : "Show More";
        });
    }
</script>

<div class="row h-100">
    <div class="col-12 h-100">
        <div class="card-box">
            <h4 class="header-title m-t-0 m-b-20">Speaking Practice</h4>
            <div class="progress"  style="height: 20px;">
                  <div class="progress-bar bg-success" role="progressbar" style="height: 20px; width: 100%" aria-valuenow="100" aria-valuemin="100" aria-valuemax="100"></div>
            </div>
            <div class="card">
                <!--card for displaying results-->
                <div class='card-body'>
                    <!--table for displaying results of a practice-->
                    {% if attempts %}
                    <table id="results_table" class="table table-hover" style="table-layout: fixed"> 
                        <div class="row header">
                            <th class="text-left">Student Transcription</th> 
                            <th class="text-center">Accuracy Score</th>
                            <th class="text-center">Fluency Score</th> 
                            <th class="text-right invisible"><button>Show More</button></th>
                        </div>
                        <tbody id="result_body">
                            <!--displays each item from context[practice data] in this table-->
                            {% for attempt in attempts %}
                                <tr style="border-top: 2px solid gray;">
                                    <td class="text-left">
                                        {{attempt.transcription}}
                                    </td>
                                    <td class="text-center">
                                        {% if attempt.teacher_reviewed %}
                                            Teacher Updated Score: 
                                        {% endif %}
                                        {{attempt.score}}%
                                    </td>
                                    <td class="text-center">
                                        {{attempt.wpm}}%
                                    </td>
                                    <td class="text-right">
                                        <button id="showMoreButton{{ attempt.id }}" onclick="showHideRow({{attempt.id}})" class="sbtn btn-outline-primary btn-sm">
                                            <!--Calls the showHideRow function when pressed, with the item id as the input-->
                                            Show More
                                        </button>
                                    </td>
                                </tr>
                                <!--row that shows hidden information-->
                                <tr id="{{attempt.id}}" class="hidden_row">
                                    <td colspan=4 class="row-indent">
                                        <table style="table-layout: fixed; margin-top: 0px; width: 100%;">
                                            <thead>
                                                <tr>
                                                    <th style="text-align: Left;">Correct Expression</th>
                                                    <th style="text-align: Left;">Given Expression</th>
                                                    <th style="text-align: Left;">Graded Expression (hover for details about each error)</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td style="text-align: Left;">
                                                        {{attempt.correct_formulation}}
                                                    </td>
                                                    <td style="text-align: Left;">
                                                        {{attempt.incorrect_expression}}
                                                    </td>
                                                    <td style="text-align: Left;">
                                                        <mark><span title="There could be errors shown here">{{attempt.transcription}}</span></mark>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                        <br>
                                        <table style="margin-top: 0px; width: 500px; display:inline-block;">
                                            <thead>
                                                <tr>
                                                    <th style="text-align: Left;">Your Recording</th>
                                                    {% if attempt.teacher_audio %}
                                                        <th style="text-align: Left;">Teacher Reformulation Audio</th>
                                                    {% endif %}
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td style="text-align: Left;">
                                                        <audio controls title="Your Recording" style="width: 200px;" class="previous_attempt_audio" src="{{ attempt.audio_path }}"></audio>
                                                    </td>
                                                    {% if attempt.teacher_audio %}
                                                        <td style="text-align: Left;">
                                                            <audio controls title="Teacher Reformulation Audio" style="width: 200px;" class="previous_attempt_audio" src="{{ attempt.teacher_audio }}"></audio>
                                                        </td>
                                                    {% endif %}
                                                </tr>
                                            </tbody>
                                        </table>
                                        {% if attempt.review_requested %}
                                            <br>
                                            {% if attempt.teacher_reviewed %}
                                                <b>Teacher Comments</b><br>
                                                {{ attempt.teacher_comments }}
                                            {% else %}
                                                <b>Review Pending</b>
                                            {% endif %}
                                        {% else%}
                                            <button style="float: right; margin-top: 80px;" type="button" id="request{{attempt.id}}" data-submit-id="{{attempt.id}}" class="request-btn sbtn btn-warning btn-sm" data-toggle="modal" data-target="#confirm-modal">
                                                Request Teacher Review
                                            </button>
                                        {% endif %}
                                        
                                    </td>
                                </tr>
                                <script>
                                    // called on instantitiation to hide the "show more" row
                                    showHideRow({{attempt.id}});
                                </script>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <h1>No results available</h1>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Modal -->
<div class="modal fade" id="confirm-modal" tabindex="-1" role="dialog" aria-labelledby="confirm-modal-label" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirm-modal-label">Are you sure?</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <span id="confirm-message"><b>Are you sure you want to request teacher review?</b><br>
                    Please listen back to your audio recording to ensure that there was a grading or 
                    transcription error before requesting review.<br>
                    If you have already done so, continue. 
                </span>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="confirm-button">Request Review</button>
            </div>
        </div>
    </div>
</div>
  
  
<div class="btn-group d-flex card-footer" role="group" aria-label="...">
    <a href="{% url 'student:course' course.id %}" class ="btn-success btn w-100 m-1">Return Home</a>
    <a href="{% url 'student:course' course.id %}" class ="btn-success btn w-100 m-1">Try Again</a>
</div>

<script src="{% static "ComSemApp/js/ComSemRecording-opus.js" %}?{% now "U" %}"></script>
<script type="text/javascript">

// Add click event listener to all request buttons
$(".request-btn").on("click", (obj) => {
    // Get the request ID from the data attribute of the button
    // obj.currentTarget is needed because obj holds information regarding the event
    // currentTarget grabs the item which initaited the event
    // this is similar to just using the 'this' call but within an arrow annonymous function
    var attempt_id = $(obj.currentTarget).data("submit-id");
  
    // Show the modal dialog box
    $("#confirm-modal").modal("show");
  
    // Add click event listener to the confirm button
    $("#confirm-button").one("click", (obj) => {
      // Submit the form with the submit ID as a parameter
      console.log("confirm clicked")
        teacherRequestClick(attempt_id);
      // Hide the modal dialog box
      $("#confirm-modal").modal("hide");
    });
  });

function teacherRequestClick(attempt_id){
    if (!$("#request" + attempt_id).hasClass("disabled")){
        console.log(attempt_id);
        $("#request" + attempt_id).removeClass("btn-warning").addClass("btn-secondary").prop("disabled", true);

        let requestFormData = new FormData(); // creates new form
        requestFormData.append( 'attempt', attempt_id);
        var csrf_token = '{{ csrf_token }}'; // grabs csrf_token for certification

        $.ajax({ // send POST request
            type: "POST",
            url: "{% url 'student:speaking_practice_review_request' course.id%}", // links SpeakingPracticeTeacherReviewRequestCreateView
            data: requestFormData,
            processData: false,
            contentType: false,
            timeout: 5000, // if takes longer than 5 secs, return timeout error
            headers: { // places token in request so that it is certified by server
                'X-CSRFToken': csrf_token
            },
            success:(response) => {
                cs_notification('success', "Request Sent")
            },
            error: (jqXHR, textStatus, errorThrown) => {
                cs_ajax_error(jqXHR, textStatus, errorThrown);
            }
            });
    }
}

</script>


<script>
function gradeSentenceHighlighting(sentence, highlight_input){
    /*
    sentence : string = The sentence that is being highlighted
    highlight_input : array[dict[str | int]] = an array of dictionaries =
            start : int = start index, will be highlighted
            end : int = end index, will also be highlighted
            comment : string = comment that will be shown when hovering over highlight

        if two highlights overlap on indexes, only the first will show and other highlight 
        will not generate
    */
    start_index = 0;
    end_index = sentence.length;
    hl_index = 0;
    html_str = "";
    background_color = "#FFFF00";

    for(let i = 0; i < end_index; i++){
        if (hl_index < highlight_input.length && i == highlight_input[hl_index]['start']){
            html_str += "<span style='background-color: " + background_color + "'";
            html_str += "title='" + highlight_input[hl_index]['comment'] + "'>"; 
            html_str += sentence.substring(i,highlight_input[hl_index]['end']+1);
            html_str += "</span>";
            i = highlight_input[hl_index]['end'];
            hl_index++;
        }
        else{
            html_str += sentence[i];
        }
    }

    return html_str
}

function placeHighlightedSentence(html_str, element_id){
    /*
        html_str : str = string of html data
        element_id : str = string id to a elemnt in the html body
        
    */
    let $element = $('#' + element_id);
    // Set the HTML content of the selected element to the generated HTML string
    $element.html(html_str);
}
</script>
{% endblock %}